#!/bin/bash

__PRMPT_ITEMS="${__PRMPT_ITEMS:-userhost cwd vcs}"

__PRMPT_OPT_color="${__PRMPT_OPT_color:-true}"
__PRMPT_OPT_color_user="${__PRMPT_OPT_color_user:-green}"
__PRMPT_OPT_color_host="${__PRMPT_OPT_color_host:-green}"
__PRMPT_OPT_color_userhost="${__PRMPT_OPT_color_userhost:-green}"
__PRMPT_OPT_color_cwd="${__PRMPT_OPT_color_cwd:-blue}"
__PRMPT_OPT_color_end="${__PRMPT_OPT_color_cwd:-green}"
__PRMPT_OPT_style="${__PRMPT_OPT_style:-simple}"
__PRMPT_OPT_powerline="${__PRMPT_OPT_powerline:-true}"

__PRMPT_OPT_end=${__PRMPT_OPT_end:-'$'}

function prmpt() {
  local cmd="$1"; shift

  case "$cmd" in
    set) __prmpt_command_set "$@" ;;
    '') PROMPT_COMMAND='__prmpt_entry' ;;
  esac
}

function __prmpt_entry() {
  local item
  local text
  local color

  __prmpt_reset
  __PRMPT_VAR_last_item=''
  __PRMPT_VAR_last_color=''

  for item in $__PRMPT_ITEMS; do
    text=
    color=
    eval "$(__prmpt_item "$item")"

    if [[ -z $color ]]; then
      color="$(__prmpt_color_item "$item")"
    fi

    if [[ -n $text ]]; then
      __prmpt_append "$(__prmpt_style "$item" "$text" "$color")"
      __PRMPT_VAR_last_item="$item"
      __PRMPT_VAR_last_color="$color"
    fi
  done

  __prmpt_append "$(__prmpt_style end "$__PRMPT_OPT_end")"
  unset __PRMPT_VAR_last_item
}

function __prmpt_reset() {
  PS1=''
}

function __prmpt_append() {
  PS1="$PS1""$@"
}

function __prmpt_item() {
  case "$1" in
    user    ) echo -n "text='\u'" ;;
    host    ) echo -n "text='\h'" ;;
    userhost) echo -n "text='\u@\h'" ;;
    cwd     ) echo -n "text='\w'" ;;
    vcs     ) __prmpt_vcs_status_valid && echo "$(__prmpt_vcs_status)" ;;
  esac
}

function __prmpt_vcs_status_valid() {
  __prmpt_vcs_is_git_directory && return 0
  return 1
}

function __prmpt_vcs_status() {
  if __prmpt_vcs_is_git_directory; then
    echo $(__prmpt_vcs_git status)
  fi
}

function __prmpt_vcs_is_git_directory() {
  local dir="$1"

  dir="$(cd "$dir"; pwd)"

  if [[ -d "$dir/.git" ]]; then
    return 0
  fi

  if [[ $dir != / ]]; then
    __prmpt_vcs_is_git_directory "$(dirname "$dir")"
    return $?
  fi

  return 1
}

function __prmpt_vcs_git() {
  local type="$1"

  case "$type" in
    status) echo "text='$(git rev-parse --abbrev-ref HEAD)'" ;;
  esac

  if [[ $(git status --porcelain | wc -l) -gt 0 ]]; then
    echo 'color=red'
  else
    echo 'color=green'
  fi
}

function __prmpt_style() {
  "__prmpt_style_${__PRMPT_OPT_style}" "$@"
}

function __prmpt_style_simple() {
  local item="$1"
  local value="$2"
  local color="$3"
  local prefix=''
  local suffix=''

  case "$__PRMPT_VAR_last_item>$item" in
    'user>host'    ) prefix='@' ;;
    'host>user'    ) prefix='/' ;;
    'host>cwd'     ) prefix=':' ;;
    'userhost>cwd' ) prefix=':' ;;
    *'>end'        ) prefix=' '; suffix=' ' ;;
    '>'*           ) ;;
    *              ) prefix=' ' ;;
  esac

  echo -n "${prefix}$(__prmpt_color fg "$color" +bold commit)"
  echo -n "${value}$(__prmpt_color reset commit)${suffix}"
}

function __prmpt_style_bracket() {
  local item="$1"
  local value="$2"
  local color="$3"

  if [[ $item == end ]]; then
    __prmpt_color fg "$color"
    echo -n " $value "
    __prmpt_color reset
  else
    echo -n "[$(__prmpt_color fg "$color" +bold commit)"
    echo -n "$value$(__prmpt_color reset commit)]"
  fi
}

function __prmpt_style_stripe() {
  local item="$1"
  local value="$2"
  local color="$3"

  if $__PRMPT_OPT_powerline; then
    __prmpt_style_stripe_arrow "$item" "$color"
  fi

  __prmpt_color reset fg "$color" bg black +standout >&2

  if [[ $item == end ]]; then
    __prmpt_color reset commit
    echo -n ' '
  else
    __prmpt_color commit
    echo -n " $2 "
  fi
}

function __prmpt_style_stripe_arrow() {
  local item="$1"
  local color="$2"
  local arrow="\xee\x82\xb0"

  if [[ -n $__PRMPT_VAR_last_item ]]; then
    __prmpt_color reset fg "$__PRMPT_VAR_last_color"

    if [[ $item != end ]]; then
      __prmpt_color bg "$color" "$item"
    else
      __prmpt_color bg black
    fi

    __prmpt_color -standout commit
    echo -ne "${arrow}"
  fi
}

function __prmpt_color_item() {
  local item="$1"
  local var_name="__PRMPT_OPT_color_$item"

  echo "${!var_name}"
}

function __prmpt_color() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      +bold) __prmpt_setopt __PRMPT_COLOR +bold ;;
      -bold) __prmpt_setopt __PRMPT_COLOR -bold ;;
      +standout) __prmpt_setopt __PRMPT_COLOR +standout ;;
      -standout) __prmpt_setopt __PRMPT_COLOR -standout ;;
      fg)
        shift
        __PRMPT_COLOR_fg="$(__prmpt_color_code "$1")"
        ;;
      bg)
        shift
        __PRMPT_COLOR_bg="$(__prmpt_color_code "$1")"
        ;;
      reset)
        __PRMPT_COLOR_fg=
        __PRMPT_COLOR_bg=
        __PRMPT_COLOR_bold=false
        __PRMPT_COLOR_standout=false
        ;;
      commit)
        echo -ne "\["
        tput sgr0
        [[ $__PRMPT_COLOR_fg ]] && tput setaf "${__PRMPT_COLOR_fg}"
        [[ $__PRMPT_COLOR_bg ]] && tput setab "${__PRMPT_COLOR_bg}"
        ${__PRMPT_COLOR_bold:-false} && tput bold
        ${__PRMPT_COLOR_standout:-false} && tput smso
        echo -ne "\]"
        ;;
    esac

    shift
  done
}

function __prmpt_command_set() {
  while [[ $# -gt 0 ]]; do
    __prmpt_setopt __PRMPT_OPT "$1"
    shift
  done
}

function __prmpt_setopt() {
  local prefix="$1"
  local def="$2"
  local var_name
  local var_value

  if [[ ${def:0:1} == '+' || ${def:0:1} == '-' ]]; then
    var_name="${def:1}"
    [[ ${def:0:1} == '+' ]] && var_value=true || var_value=false
  else
    var_name="$(echo "$def" | sed -e 's/\([a-zA-Z0-9_-]\+\)=.*/\1/p; d' | tr - _)"
    var_value="$(echo "$def" | sed -e 's/[^=]\+=\(.*\)/\1/')"
  fi

  eval "${prefix}_${var_name}='$var_value'"
}

function __prmpt_color_code() {
  case "$1" in
    black  ) echo ;;
    red    ) echo 1 ;;
    green  ) echo 2 ;;
    yellow ) echo 3 ;;
    blue   ) echo 4 ;;
    magenta) echo 5 ;;
    yellow ) echo 6 ;;
    white|*) echo 7 ;;
  esac
}
